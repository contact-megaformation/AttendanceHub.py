# AttendanceHub.py
# ุฅุฏุงุฑุฉ ุงูุบูุงุจุงุช ูููุชูููููู โ ุชุฎุฒูู ูุญููู (JSON) โ ุจุฏูู Google Sheets
# ููุฒุงุช: ูุฑูุน (ุจูููุฉ ุณุฑ) + ุงุฎุชุตุงุตุงุช + ููุงุฏ (ุณุงุนุงุช/ุฃุณุจูุน + ุฅุฌูุงูู ุณุงุนุงุช)
#        ูุชูููููู (ุฑูู ุงููุชูููู + ุฑูู ุงูููู) + ุบูุงุจุงุช ูุน ุดูุงุฏุฉ ุทุจูุฉ
#        ูุงุชุณุงุจ ูููุชูููู ุฃู ุงูููู + ุชูุงุฑูุฑ
# ููุงุญุธุฉ: ุญูุงูุฉ ุงููุฑูุน ุจูููุฉ ุณุฑ ุนุจุฑ st.secrets['branch_passwords'] (MB/BZ)

import os, json, uuid
from datetime import datetime, date, timedelta
from typing import Dict, Any, List

import streamlit as st
import pandas as pd

# =============== ุฅุนุฏุงุฏ ุงูุตูุญุฉ ===============
st.set_page_config(page_title="Attendance Hub", layout="wide")
st.markdown("""
<div style="text-align:center">
  <h1>๐งพ Attendance Hub โ ุฅุฏุงุฑุฉ ุบูุงุจุงุช ุงููุชูููููู</h1>
  <p>ูุฑูุน (ูุญููุฉ ุจูููุฉ ุณุฑ) + ุงุฎุชุตุงุตุงุช + ููุงุฏ + ุบูุงุจุงุช + ูุงุชุณุงุจ</p>
</div>
<hr>
""", unsafe_allow_html=True)

# =============== ูุณุงุฑุงุช ุงูุชุฎุฒูู ===============
ROOT = os.getcwd()
DATA_DIR = os.path.join(ROOT, "attendance_data")
DB_PATH  = os.path.join(DATA_DIR, "attendance_db.json")

def ensure_store():
    os.makedirs(DATA_DIR, exist_ok=True)
    if not os.path.exists(DB_PATH):
        with open(DB_PATH, "w", encoding="utf-8") as f:
            json.dump({
                "branches": ["Menzel Bourguiba", "Bizerte"],
                "specialties": [],            # ูุงุฆูุฉ ุงูุงุฎุชุตุงุตุงุช
                "subjects": [],               # [{id, name, branch, specialty, weekly_hours, total_hours}]
                "trainees": [],               # [{id, name, phone, guardian_phone, branch, specialty}]
                "absences": []                # [{id, trainee_id, subject_id, date, hours, medical_excused, note}]
            }, f, ensure_ascii=False, indent=2)

def load_db() -> Dict[str, Any]:
    ensure_store()
    try:
        with open(DB_PATH, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return {"branches": [], "specialties": [], "subjects": [], "trainees": [], "absences": []}

def save_db(db: Dict[str, Any]):
    os.makedirs(DATA_DIR, exist_ok=True)
    tmp = DB_PATH + ".tmp"
    with open(tmp, "w", encoding="utf-8") as f:
        json.dump(db, f, ensure_ascii=False, indent=2, default=str)
    os.replace(tmp, DB_PATH)

def human_dt(ts) -> str:
    dt = pd.to_datetime(ts, errors="coerce")
    if pd.isna(dt): return "-"
    return dt.strftime("%Y-%m-%d")

def new_id() -> str:
    return uuid.uuid4().hex[:10]

# =============== ุฏูุงู ูุณุงุนุฏุฉ ูููุงุชุณุงุจ ===============
def normalize_phone(s: str) -> str:
    s = str(s or "")
    digits = "".join([c for c in s if c.isdigit()])
    if digits.startswith("216"):
        return digits
    if len(digits) == 8:
        return "216" + digits
    return digits

def wa_link(number: str, message: str) -> str:
    n = normalize_phone(number)
    if not n: return ""
    from urllib.parse import quote
    return f"https://wa.me/{n}?text={quote(message)}"

# =============== ุญูุงูุฉ ุงููุฑูุน ุจูููุฉ ุณุฑ ===============
def _branch_passwords() -> Dict[str, str]:
    """ููุฑู ูููุงุช ุณุฑ ุงููุฑูุน ูู secretsุ ูุฅูุง ูุณุชุนูู ููู ุงูุชุฑุงุถูุฉ."""
    try:
        b = st.secrets["branch_passwords"]
        return {
            "Menzel Bourguiba": str(b.get("MB", "MB_2025!")),
            "Bizerte": str(b.get("BZ", "BZ_2025!")),
        }
    except Exception:
        return {"Menzel Bourguiba": "MB_2025!", "Bizerte": "BZ_2025!"}

def _branch_unlocked(branch: str) -> bool:
    ok = st.session_state.get(f"branch_ok::{branch}", False)
    ts = st.session_state.get(f"branch_ok_at::{branch}")
    if not (ok and ts): return False
    return (datetime.now() - ts) <= timedelta(minutes=30)

def branch_lock_ui(branch: str, ns_key: str):
    """ูุฑุณู UI ูููุฑุน: ุฅุฏุฎุงู ูููุฉ ุณุฑ/ููู. ูููู ุงูุชุงุจ ุฅุฐุง ูุด ููุชูุญ."""
    pw_map = _branch_passwords()
    if _branch_unlocked(branch):
        c1, c2 = st.columns([3,1])
        c1.success(f"โ ูุฑุน '{branch}' ููุชูุญ (ุตุงูุญ ูู 30 ุฏูููุฉ).")
        if c2.button("ููู ุงููุฑุน", key=f"lock::{ns_key}::{branch}"):
            st.session_state[f"branch_ok::{branch}"] = False
            st.session_state[f"branch_ok_at::{branch}"] = None
            st.rerun()
        return True
    else:
        st.info(f"๐ ุฃุฏุฎู ูููุฉ ุณุฑู ูุฑุน: **{branch}** ูููุชุงุจุนุฉ")
        pw_try = st.text_input("ูููุฉ ุณุฑู ุงููุฑุน", type="password", key=f"pw::{ns_key}::{branch}")
        if st.button("ูุชุญ ุงููุฑุน", key=f"open::{ns_key}::{branch}"):
            if pw_try == pw_map.get(branch, ""):
                st.session_state[f"branch_ok::{branch}"] = True
                st.session_state[f"branch_ok_at::{branch}"] = datetime.now()
                st.success("ุชูู ุงููุชุญ โ")
                st.rerun()
            else:
                st.error("โ ูููุฉ ุณุฑ ุบูุฑ ุตุญูุญุฉ.")
        st.stop()

# =============== ุชุญููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ===============
db = load_db()

# =============== Tabs ===============
tab_cfg, tab_tr, tab_abs, tab_rpt, tab_msg = st.tabs([
    "โ๏ธ ุถุจุท ุงููุธุงู", "๐ฅ ุงููุชูููููู", "๐ ุงูุบูุงุจุงุช", "๐ ุงูุชูุงุฑูุฑ", "๐ฌ ุงูุฑุณุงุฆู"
])

# ========================== (1) ุถุจุท ุงููุธุงู ==========================
with tab_cfg:
    st.subheader("ุงููุฑูุน ู ุงูุงุฎุชุตุงุตุงุช ู ุงูููุงุฏ")

    # ------ ุฅุฏุงุฑุฉ ุงูุงุฎุชุตุงุตุงุช ------
    with st.expander("๐ ุงูุงุฎุชุตุงุตุงุช", expanded=True):
        col_s1, col_s2 = st.columns([3,2])
        with col_s1:
            st.write("ุงูุงุฎุชุตุงุตุงุช ุงูุญุงููุฉ:")
            if len(db["specialties"]) == 0:
                st.info("ูุง ุชูุฌุฏ ุงุฎุชุตุงุตุงุช ุจุนุฏ.")
            else:
                st.dataframe(pd.DataFrame({"ุงูุงุฎุชุตุงุต": db["specialties"]}), use_container_width=True)

        with col_s2:
            new_spec = st.text_input("โ ุฅุถุงูุฉ ุงุฎุชุตุงุต", key="cfg_add_spec_input")
            if st.button("ุฅุถุงูุฉ ุงูุงุฎุชุตุงุต", key="cfg_add_spec_btn"):
                spec = new_spec.strip()
                if not spec:
                    st.error("ุงูุชุจ ุงุณู ุงุฎุชุตุงุต.")
                elif spec in db["specialties"]:
                    st.warning("ุงูุงุฎุชุตุงุต ููุฌูุฏ.")
                else:
                    db["specialties"].append(spec)
                    save_db(db)
                    st.success("ุชููุช ุงูุฅุถุงูุฉ โ")
                    st.rerun()

            if db["specialties"]:
                del_spec = st.selectbox("๐๏ธ ุญุฐู ุงุฎุชุตุงุต", db["specialties"], key="cfg_del_spec_sel")
                if st.button("ุญุฐู", key="cfg_del_spec_btn"):
                    used_in_subjects = any(s["specialty"] == del_spec for s in db["subjects"])
                    used_in_trainees = any(t["specialty"] == del_spec for t in db["trainees"])
                    if used_in_subjects or used_in_trainees:
                        st.error("ูุง ูููู ุงูุญุฐู: ุงูุงุฎุชุตุงุต ูุณุชุนูู ูู ููุงุฏ/ูุชูููููู.")
                    else:
                        db["specialties"] = [s for s in db["specialties"] if s != del_spec]
                        save_db(db)
                        st.success("ุชูู ุงูุญุฐู โ")
                        st.rerun()

    st.markdown("---")

    # ------ ุฅุฏุงุฑุฉ ุงูููุงุฏ ------
    with st.expander("๐ ุงูููุงุฏ ููู ูุฑุน + ุงุฎุชุตุงุต", expanded=True):
        col_a, col_b = st.columns(2)

        with col_a:
            st.write("ูุงุฆูุฉ ุงูููุงุฏ")
            if not db["subjects"]:
                st.info("ูุง ุชูุฌุฏ ููุงุฏ ุจุนุฏ.")
            else:
                subs = pd.DataFrame(db["subjects"])
                if not subs.empty:
                    subs_disp = subs.copy()
                    subs_disp["ุงููุฑุน"] = subs_disp["branch"]
                    subs_disp["ุงูุงุฎุชุตุงุต"] = subs_disp["specialty"]
                    subs_disp["ุงููุงุฏุฉ"] = subs_disp["name"]
                    subs_disp["ุณ/ุฃุณุจูุน"] = subs_disp["weekly_hours"]
                    subs_disp["ุฅุฌูุงูู ุณุงุนุงุช"] = subs_disp["total_hours"]
                    st.dataframe(subs_disp[["ุงููุฑุน","ุงูุงุฎุชุตุงุต","ุงููุงุฏุฉ","ุณ/ุฃุณุจูุน","ุฅุฌูุงูู ุณุงุนุงุช"]], use_container_width=True, height=320)

        with col_b:
            st.write("โ ุฅุถุงูุฉ/ุชุนุฏูู ูุงุฏุฉ")
            branch_sel = st.selectbox("ุงููุฑุน", db["branches"], key="cfg_sub_branch")
            spec_sel   = st.selectbox("ุงูุงุฎุชุตุงุต", db["specialties"] or ["โ"], key="cfg_sub_spec")
            sub_name   = st.text_input("ุงุณู ุงููุงุฏุฉ", key="cfg_sub_name")
            wh         = st.number_input("ุณุงุนุงุช ุฃุณุจูุนูุฉ", min_value=0.0, step=1.0, key="cfg_sub_wh")
            th         = st.number_input("ุฅุฌูุงูู ุณุงุนุงุช ุงููุงุฏุฉ", min_value=0.0, step=1.0, key="cfg_sub_th")

            if st.button("ุญูุธ ูุงุฏุฉ", key="cfg_sub_save"):
                if not sub_name.strip():
                    st.error("ุงุณู ุงููุงุฏุฉ ูุทููุจ.")
                elif spec_sel == "โ" or not spec_sel:
                    st.error("ุงุฎุชุฑ ุงุฎุชุตุงุต.")
                else:
                    exist = next((s for s in db["subjects"]
                                  if s["name"].strip().lower()==sub_name.strip().lower()
                                  and s["branch"]==branch_sel and s["specialty"]==spec_sel), None)
                    if exist:
                        exist["weekly_hours"] = float(wh)
                        exist["total_hours"]  = float(th)
                        save_db(db); st.success("ุชูู ุงูุชุญุฏูุซ โ")
                    else:
                        db["subjects"].append({
                            "id": new_id(),
                            "name": sub_name.strip(),
                            "branch": branch_sel,
                            "specialty": spec_sel,
                            "weekly_hours": float(wh),
                            "total_hours": float(th)
                        })
                        save_db(db); st.success("ุชููุช ุงูุฅุถุงูุฉ โ")
                    st.rerun()

            existing_subs = [f"{s['name']} โ {s['branch']} โ {s['specialty']}" for s in db["subjects"]]
            if existing_subs:
                del_pick = st.selectbox("๐๏ธ ุงุฎุชุฑ ูุงุฏุฉ ููุญุฐู", existing_subs, key="cfg_sub_del_pick")
                if st.button("ุญุฐู ุงููุงุฏุฉ", key="cfg_sub_del_btn"):
                    idx = existing_subs.index(del_pick)
                    sub_id = db["subjects"][idx]["id"]
                    if any(a["subject_id"] == sub_id for a in db["absences"]):
                        st.error("ูุง ูููู ุงูุญุฐู: ุงููุงุฏุฉ ูุณุชุนููุฉ ูู ุณุฌูุงุช ุบูุงุจ.")
                    else:
                        db["subjects"].pop(idx)
                        save_db(db)
                        st.success("ุชูู ุงูุญุฐู โ")
                        st.rerun()

# ========================== (2) ุงููุชูููููู ==========================
with tab_tr:
    st.subheader("ุฅุฏุงุฑุฉ ุงููุชูููููู")

    # ุงุฎุชูุงุฑ ุงููุฑุน (ูุน ูููุฉ ุณุฑ)
    tr_branch_view = st.selectbox("ุงููุฑุน", db["branches"], key="tr_view_branch")
    branch_lock_ui(tr_branch_view, ns_key="tab_tr")

    # ูุงุฆูุฉ ุงููุชูููููู (ูุฑุน ููุท)
    col_tl, col_tr = st.columns([3,2])
    with col_tl:
        st.write(f"ุงููุงุฆูุฉ โ ูุฑุน {tr_branch_view}")
        tr_df = pd.DataFrame([t for t in db["trainees"] if t["branch"] == tr_branch_view])
        if tr_df.empty:
            st.info("ูุง ููุฌุฏ ูุชูููููู ุจุนุฏ ูู ูุฐุง ุงููุฑุน.")
        else:
            disp = tr_df.copy()
            disp["ุงูุงุณู"] = disp["name"]
            disp["ุงููุงุชู"] = disp["phone"]
            disp["ูุงุชู ุงูููู"] = disp["guardian_phone"]
            disp["ุงูุงุฎุชุตุงุต"] = disp["specialty"]
            st.dataframe(disp[["ุงูุงุณู","ุงููุงุชู","ูุงุชู ุงูููู","ุงูุงุฎุชุตุงุต"]], use_container_width=True, height=380)

    # ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู (ููููุฏ ุจุงููุฑุน ุงูููุชูุญ)
    with col_tr:
        st.write("โ ุฅุถุงูุฉ ูุชูููู")
        t_name  = st.text_input("ุงูุงุณู ู ุงูููุจ", key="tr_add_name")
        # ุงููุฑุน ุซุงุจุช = ุงููุฎุชุงุฑ
        st.selectbox("ุงููุฑุน", [tr_branch_view], index=0, key="tr_add_branch_show", disabled=True)
        t_spec  = st.selectbox("ุงูุงุฎุชุตุงุต", db["specialties"] or ["โ"], key="tr_add_spec")
        t_phone = st.text_input("ูุงุชู ุงููุชูููู", key="tr_add_phone")
        g_phone = st.text_input("ูุงุชู ุงูููู", key="tr_add_gphone")

        if st.button("ุฅุถุงูุฉ", key="tr_add_btn"):
            if not t_name.strip():
                st.error("ุงูุงุณู ูุทููุจ.")
            elif not t_spec or t_spec == "โ":
                st.error("ุงูุงุฎุชุตุงุต ูุทููุจ.")
            else:
                db["trainees"].append({
                    "id": new_id(),
                    "name": t_name.strip(),
                    "branch": tr_branch_view,  # ูุฑุน ูุญูู
                    "specialty": t_spec,
                    "phone": normalize_phone(t_phone),
                    "guardian_phone": normalize_phone(g_phone)
                })
                save_db(db)
                st.success("ุชููุช ุงูุฅุถุงูุฉ โ")
                st.rerun()

        st.markdown("---")

        # ุชุนุฏูู/ุญุฐู ูุชูููู (ูู ูุฐุง ุงููุฑุน ููุท)
        tr_list = [t for t in db["trainees"] if t["branch"] == tr_branch_view]
        if tr_list:
            edit_pick = st.selectbox("โ๏ธ ุงุฎุชุฑ ูุชูููู ููุชุนุฏูู/ุงูุญุฐู",
                                     [f"{t['name']} โ {t['specialty']}" for t in tr_list],
                                     key="tr_edit_pick")
            idx = [f"{t['name']} โ {t['specialty']}" for t in tr_list].index(edit_pick)
            cur = tr_list[idx]

            ename  = st.text_input("ุงูุงุณู", value=cur["name"], key=f"tr_edit_name_{cur['id']}")
            # ุงููุฑุน ุซุงุจุช
            st.selectbox("ุงููุฑุน", [tr_branch_view], index=0, key=f"tr_edit_branch_{cur['id']}", disabled=True)
            espec  = st.selectbox("ุงูุงุฎุชุตุงุต", db["specialties"] or ["โ"],
                                  index=(db["specialties"].index(cur["specialty"]) if cur["specialty"] in db["specialties"] else 0),
                                  key=f"tr_edit_spec_{cur['id']}")
            ephone = st.text_input("ูุงุชู ุงููุชูููู", value=cur["phone"], key=f"tr_edit_phone_{cur['id']}")
            egphone= st.text_input("ูุงุชู ุงูููู", value=cur["guardian_phone"], key=f"tr_edit_gphone_{cur['id']}")

            c1, c2 = st.columns(2)
            if c1.button("๐พ ุญูุธ ุงูุชุนุฏููุงุช", key=f"tr_edit_save_{cur['id']}"):
                if not ename.strip():
                    st.error("ุงูุงุณู ูุทููุจ.")
                elif not espec or espec == "โ":
                    st.error("ุงูุงุฎุชุตุงุต ูุทููุจ.")
                else:
                    # ุชุญุฏูุซ ูู db ุงูุฃุตูู
                    for t in db["trainees"]:
                        if t["id"] == cur["id"]:
                            t["name"] = ename.strip()
                            t["specialty"] = espec
                            t["phone"] = normalize_phone(ephone)
                            t["guardian_phone"] = normalize_phone(egphone)
                            break
                    save_db(db)
                    st.success("ุชูู ุงูุญูุธ โ")
                    st.rerun()

            if c2.button("๐๏ธ ุญุฐู ุงููุชูููู", key=f"tr_edit_del_{cur['id']}"):
                tid = cur["id"]
                db["absences"] = [a for a in db["absences"] if a["trainee_id"] != tid]
                db["trainees"]  = [t for t in db["trainees"] if t["id"] != tid]
                save_db(db)
                st.success("ุชูู ุงูุญุฐู โ")
                st.rerun()

# ========================== (3) ุงูุบูุงุจุงุช ==========================
with tab_abs:
    st.subheader("ุชุณุฌูู ุงูุบูุงุจุงุช / ุชุนุฏูููุง")

    if not db["trainees"]:
        st.info("ูุง ููุฌุฏ ูุชูููููู. ุฃุถู ูู ุชุจููุจ ุงููุชูููููู.")
        st.stop()

    col_f1, col_f2 = st.columns(2)
    pick_branch = col_f1.selectbox("ุงููุฑุน", db["branches"], key="abs_pick_branch")
    # ุญูุงูุฉ ุงููุฑุน
    branch_lock_ui(pick_branch, ns_key="tab_abs")

    specs_in_branch = sorted(list({t["specialty"] for t in db["trainees"] if t["branch"] == pick_branch}))
    if not specs_in_branch:
        col_f2.info("ูุง ุงุฎุชุตุงุตุงุช ูู ูุฐุง ุงููุฑุน.")
        st.stop()
    pick_spec = col_f2.selectbox("ุงูุงุฎุชุตุงุต", specs_in_branch, key="abs_pick_spec")

    trainees_scope = [t for t in db["trainees"] if t["branch"]==pick_branch and t["specialty"]==pick_spec]
    if not trainees_scope:
        st.info("ูุง ูุชูููููู ูู ูุฐุง ุงูุงุฎุชุตุงุต.")
        st.stop()

    tr_pick = st.selectbox("ุงุฎุชุฑ ุงููุชูููู",
                           [f"{t['name']} โ {t['specialty']}" for t in trainees_scope],
                           key="abs_tr_pick")
    tr_idx = [f"{t['name']} โ {t['specialty']}" for t in trainees_scope].index(tr_pick)
    tr_obj = trainees_scope[tr_idx]

    sub_scope = [s for s in db["subjects"] if s["branch"]==pick_branch and s["specialty"]==pick_spec]
    if not sub_scope:
        st.warning("ูุง ููุงุด ููุงุฏ ูุถุจูุทุฉ ููุฐุง ุงููุฑุน/ุงูุงุฎุชุตุงุต. ุฃุถู ููุงุฏ ูู ุถุจุท ุงููุธุงู.")
        st.stop()

    sub_pick = st.selectbox("ุงููุงุฏุฉ",
                            [f"{s['name']} โ ุณ/ุฃุณุจูุน:{s['weekly_hours']} โ ุฅุฌูุงูู:{s['total_hours']}" for s in sub_scope],
                            key="abs_sub_pick")
    sub_idx = [f"{s['name']} โ ุณ/ุฃุณุจูุน:{s['weekly_hours']} โ ุฅุฌูุงูู:{s['total_hours']}" for s in sub_scope].index(sub_pick)
    sub_obj = sub_scope[sub_idx]

    total_hours = float(sub_obj.get("total_hours", 0.0))
    limit_hours = round(total_hours * 0.10, 2)
    abs_for_this = [a for a in db["absences"] if a["trainee_id"]==tr_obj["id"] and a["subject_id"]==sub_obj["id"]]
    non_excused_hours = sum(float(a.get("hours", 0.0)) for a in abs_for_this if not a.get("medical_excused", False))
    remaining = max(limit_hours - non_excused_hours, 0.0)

    st.info(f"ุณูู ุงูุบูุงุจ (10% ูู {total_hours} ุณ) = **{limit_hours} ุณ** | ุบูุฑ ูุนุฐูุฑ ูุณุฌูู: **{non_excused_hours} ุณ** | ุงูุจุงูู ูุจู ุงูุณูู: **{remaining} ุณ**")

    st.markdown("### โ ุชุณุฌูู ุบูุงุจ")
    with st.form(f"abs_add_form_{tr_obj['id']}_{sub_obj['id']}"):
        adate = st.date_input("ุงูุชุงุฑูุฎ", value=date.today(), key=f"abs_add_date_{tr_obj['id']}")
        ahours= st.number_input("ุนุฏุฏ ุงูุณุงุนุงุช ุงูุบุงุฆุจุฉ", min_value=0.0, step=1.0, key=f"abs_add_hours_{tr_obj['id']}")
        med   = st.checkbox("ุดูุงุฏุฉ ุทุจูุฉ (ุบูุงุจ ูุนุฐูุฑ โ ูุง ูุชุญุณุจุด)", key=f"abs_add_med_{tr_obj['id']}")
        note  = st.text_area("ููุงุญุธุฉ (ุงุฎุชูุงุฑู)", key=f"abs_add_note_{tr_obj['id']}")
        subm  = st.form_submit_button("ุญูุธ ุงูุบูุงุจ", use_container_width=True)
    if subm:
        if ahours <= 0:
            st.error("ุงูุณุงุนุงุช ูุงุฒู > 0.")
        else:
            db["absences"].append({
                "id": new_id(),
                "trainee_id": tr_obj["id"],
                "subject_id": sub_obj["id"],
                "date": str(adate),
                "hours": float(ahours),
                "medical_excused": bool(med),
                "note": note.strip()
            })
            save_db(db)
            st.success("ุชูู ุงูุญูุธ โ")
            st.rerun()

    st.markdown("### โ๏ธ ุชุนุฏูู/ุญุฐู ุงูุบูุงุจุงุช ุงูุณุงุจูุฉ")
    if not abs_for_this:
        st.info("ูุง ุชูุฌุฏ ุบูุงุจุงุช ูุณุฌููุฉ ููุฐู ุงููุงุฏุฉ.")
    else:
        gdf = pd.DataFrame(abs_for_this).copy()
        gdf["ุงูุชุงุฑูุฎ"] = gdf["date"].apply(human_dt)
        gdf["ุณุงุนุงุช"] = gdf["hours"]
        gdf["ูุนุฐูุฑุ"] = gdf["medical_excused"].apply(lambda x: "ูุนู" if x else "ูุง")
        gdf["ููุงุญุธุฉ"] = gdf["note"]
        st.dataframe(gdf[["ุงูุชุงุฑูุฎ","ุณุงุนุงุช","ูุนุฐูุฑุ","ููุงุญุธุฉ"]], use_container_width=True, height=260)

        pick_abs = st.selectbox(
            "ุงุฎุชุฑ ุณุฌู ุบูุงุจ ููุชุนุฏูู/ุงูุญุฐู",
            [f"{a['date']} โ {a['hours']}ุณ โ {'ูุนุฐูุฑ' if a.get('medical_excused', False) else 'ุบูุฑ ูุนุฐูุฑ'} โ {a['id']}"
             for a in abs_for_this],
            key=f"abs_edit_pick_{tr_obj['id']}"
        )
        pick_id = pick_abs.split("โ")[-1].strip()
        cur_abs = next(a for a in abs_for_this if a["id"] == pick_id)

        col_e1, col_e2 = st.columns(2)
        with col_e1:
            edate = st.date_input("ุงูุชุงุฑูุฎ", value=pd.to_datetime(cur_abs["date"]).date(), key=f"abs_edit_date_{pick_id}")
            ehours= st.number_input("ุงูุณุงุนุงุช", min_value=0.0, step=1.0, value=float(cur_abs["hours"]), key=f"abs_edit_hours_{pick_id}")
            emed  = st.checkbox("ุดูุงุฏุฉ ุทุจูุฉ (ูุนุฐูุฑ)", value=bool(cur_abs.get("medical_excused", False)), key=f"abs_edit_med_{pick_id}")
        with col_e2:
            enote = st.text_area("ููุงุญุธุฉ", value=str(cur_abs.get("note","")), key=f"abs_edit_note_{pick_id}")
            c_b1, c_b2 = st.columns(2)
            if c_b1.button("๐พ ุญูุธ ุงูุชุนุฏููุงุช", key=f"abs_edit_save_{pick_id}"):
                cur_abs["date"] = str(edate)
                cur_abs["hours"] = float(ehours)
                cur_abs["medical_excused"] = bool(emed)
                cur_abs["note"] = enote.strip()
                save_db(db)
                st.success("ุชู ุงูุญูุธ โ")
                st.rerun()
            if c_b2.button("๐๏ธ ุญุฐู ุงูุณุฌู", key=f"abs_edit_del_{pick_id}"):
                db["absences"] = [a for a in db["absences"] if a["id"] != pick_id]
                save_db(db)
                st.success("ุชู ุงูุญุฐู โ")
                st.rerun()

# ========================== (4) ุงูุชูุงุฑูุฑ ==========================
with tab_rpt:
    st.subheader("ุชูุงุฑูุฑ / ููุฎุตุงุช")
    if not db["trainees"] or not db["subjects"]:
        st.info("ุฃุถู ูุชูููููู ูููุงุฏ ุฃููุงู.")
        st.stop()

    col_r1, col_r2, col_r3 = st.columns(3)
    r_branch = col_r1.selectbox("ุงููุฑุน", db["branches"], key="rpt_branch")
    branch_lock_ui(r_branch, ns_key="tab_rpt")  # ุญูุงูุฉ ุงููุฑุน ูู ุงูุชูุงุฑูุฑ

    r_specs = sorted(list({t["specialty"] for t in db["trainees"] if t["branch"] == r_branch}))
    if not r_specs:
        st.info("ูุง ุงุฎุชุตุงุตุงุช ูู ูุฐุง ุงููุฑุน.")
        st.stop()
    r_spec = col_r2.selectbox("ุงูุงุฎุชุตุงุต", r_specs, key="rpt_spec")
    r_subs = [s for s in db["subjects"] if s["branch"]==r_branch and s["specialty"]==r_spec]
    if not r_subs:
        st.info("ูุง ููุงุฏ ููุฐุง ุงูุงุฎุชุตุงุต ูู ูุฐุง ุงููุฑุน.")
        st.stop()
    r_sub = col_r3.selectbox("ุงููุงุฏุฉ", [f"{s['name']} โ ุฅุฌูุงูู:{s['total_hours']}" for s in r_subs], key="rpt_sub")
    r_sub_id = r_subs[[f"{s['name']} โ ุฅุฌูุงูู:{s['total_hours']}" for s in r_subs].index(r_sub)]["id"]
    r_total = float(next(s for s in db["subjects"] if s["id"]==r_sub_id)["total_hours"])
    r_limit = round(r_total*0.10, 2)

    trainees_scope = [t for t in db["trainees"] if t["branch"]==r_branch and t["specialty"]==r_spec]
    rows = []
    for t in trainees_scope:
        abs_t = [a for a in db["absences"] if a["trainee_id"]==t["id"] and a["subject_id"]==r_sub_id]
        non_exc = sum(float(a["hours"]) for a in abs_t if not a.get("medical_excused", False))
        rows.append({
            "ุงููุชูููู": t["name"],
            "ุงููุงุชู": t["phone"],
            "ูุงุชู ุงูููู": t["guardian_phone"],
            "ุบูุงุจ ุบูุฑ ูุนุฐูุฑ (ุณ)": non_exc,
            "ุณูู 10% (ุณ)": r_limit,
            "ุงููุชุจููู ูุจู ุงูุณูู (ุณ)": max(r_limit - non_exc, 0.0)
        })
    rpt_df = pd.DataFrame(rows)
    st.dataframe(rpt_df, use_container_width=True)

# ========================== (5) ุงูุฑุณุงุฆู ==========================
with tab_msg:
    st.subheader("ุฅุฑุณุงู ุฑุณุงูุฉ ูุงุชุณุงุจ")
    if not db["trainees"]:
        st.info("ูุง ููุฌุฏ ูุชูููููู.")
        st.stop()

    col_m1, col_m2, col_m3 = st.columns(3)
    m_branch = col_m1.selectbox("ุงููุฑุน", db["branches"], key="msg_branch")
    branch_lock_ui(m_branch, ns_key="tab_msg")  # ุญูุงูุฉ ุงููุฑุน ูู ุงูุฑุณุงุฆู

    m_specs  = sorted(list({t["specialty"] for t in db["trainees"] if t["branch"]==m_branch}))
    if not m_specs:
        st.info("ูุง ุงุฎุชุตุงุตุงุช ูู ูุฐุง ุงููุฑุน.")
        st.stop()
    m_spec   = col_m2.selectbox("ุงูุงุฎุชุตุงุต", m_specs, key="msg_spec")
    m_subs   = [s for s in db["subjects"] if s["branch"]==m_branch and s["specialty"]==m_spec]
    if not m_subs:
        st.info("ูุง ููุงุฏ.")
        st.stop()
    m_sub_pick = col_m3.selectbox("ุงููุงุฏุฉ", [f"{s['name']} โ ุฅุฌูุงูู:{s['total_hours']}" for s in m_subs], key="msg_sub")

    m_sub = m_subs[[f"{s['name']} โ ุฅุฌูุงูู:{s['total_hours']}" for s in m_subs].index(m_sub_pick)]
    m_total = float(m_sub["total_hours"])
    m_limit = round(m_total*0.10, 2)

    m_trs = [t for t in db["trainees"] if t["branch"]==m_branch and t["specialty"]==m_spec]
    m_tr_pick = st.selectbox("ุงููุชูููู", [f"{t['name']} โ {t['specialty']}" for t in m_trs], key="msg_tr_pick")
    m_tr = m_trs[[f"{t['name']} โ {t['specialty']}" for t in m_trs].index(m_tr_pick)]

    m_abs = [a for a in db["absences"] if a["trainee_id"]==m_tr["id"] and a["subject_id"]==m_sub["id"]]
    m_non_exc = sum(float(a["hours"]) for a in m_abs if not a.get("medical_excused", False))
    m_rest = max(m_limit - m_non_exc, 0.0)

    target = st.radio("ุงููุฑุณู ุฅููู", ["ุงููุชูููู","ุงูููู"], horizontal=True, key=f"msg_target_radio_{m_tr['id']}")
    base_phone = m_tr["phone"] if target == "ุงููุชูููู" else m_tr["guardian_phone"]

    default_msg = (
        f"ุงูุณูุงู ุนูููู {m_tr['name']}ุ\n"
        f"ุจุฎุตูุต ูุงุฏุฉ: {m_sub['name']}\n"
        f"ุฅุฌูุงูู ุงูุณุงุนุงุช: {m_total} ุณ โ ุณูู ุงูุบูุงุจ (10%): {m_limit} ุณ\n"
        f"ุบูุงุจุงุช ุบูุฑ ูุนุฐูุฑุฉ ูุณุฌููุฉ: {m_non_exc} ุณ โ ุงููุชุจูู ูุจู ุชุฌุงูุฒ ุงูุณูู: {m_rest} ุณ.\n"
        f"ูุฑุฌู ุงูุงูุชุฒุงู ุจุงูุญุถูุฑ. ุดูุฑุงู."
    )
    msg_text = st.text_area("ูุต ุงูุฑุณุงูุฉ", value=default_msg, key=f"msg_text_{m_tr['id']}")
    if st.button("๐ฒ ูุชุญ ูุงุชุณุงุจ", key=f"msg_send_btn_{m_tr['id']}"):
        link = wa_link(base_phone, msg_text)
        if link:
            st.markdown(f"[ุงูุชุญ ุงููุญุงุฏุซุฉ ุงูุขู]({link})")
            st.info("ุงุถุบุท ุนูู ุงูุฑุงุจุท ููุชุญ ูุงุชุณุงุจ.")
        else:
            st.error("ุฑูู ุงููุงุชู ุบูุฑ ุตุงูุญ.")
